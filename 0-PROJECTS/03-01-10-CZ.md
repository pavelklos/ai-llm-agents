<small>Claude Sonnet 4 **(Systém Inteligence Realitních Nemovitostí (Real Estate Property Intelligence System))**</small>
# Real Estate Property Intelligence System

## Klíčové Koncepty

### RAG (Retrieval-Augmented Generation)
Architektura kombinující vyhledávání relevantních informací z databáze znalostí s generativní AI pro vytváření přesných a kontextuálních odpovědí na dotazy o nemovitostech.

### Property Listings (Výpisy Nemovitostí)
Strukturovaná data o nemovitostech obsahující informace jako cena, lokace, velikost, typ, vybavení a historické údaje o prodeji.

### Market Reports (Tržní Zprávy)
Analytické dokumenty poskytující přehledy o trendech trhu nemovitostí, cenových změnách a prognózách pro různé oblasti.

### Neighborhood Data (Data o Čtvrtích)
Demografické, ekonomické a sociální informace o lokalitách, včetně škol, dopravy, bezpečnosti a služeb.

### Geospatial Search (Geoprostorové Vyhledávání)
Vyhledávání založené na geografických souřadnicích umožňující nalezení nemovitostí podle vzdálenosti, oblasti nebo prostorových vztahů.

### PostGIS
PostgreSQL rozšíření pro práci s geoprostorovými daty, umožňující efektivní ukládání a dotazování geografických informací.

### Location Embeddings (Lokační Vektorové Reprezentace)
Vektorové reprezentace geografických lokací zachycující sémantické vztahy mezi místy pro podobnostní vyhledávání.

## Komplexní Vysvětlení Projektu

Systém Inteligence Realitních Nemovitostí je pokročilá RAG aplikace navržená pro poskytování komplexních a kontextuálních informací o realitním trhu. Projekt řeší hlavní výzvy v oblasti nemovitostí:

**Hlavní Cíle:**
- Centralizace fragmentovaných realitních dat
- Poskytování inteligentních doporučení založených na AI
- Geoprostorová analýza a vizualizace trhů
- Prediktivní analýza cenových trendů

**Klíčové Výzvy:**
- Integrace heterogenních datových zdrojů
- Zpracování geoprostorových dat ve velkém měřítku
- Zajištění aktuálnosti a přesnosti informací
- Škálovatelnost pro miliony nemovitostí

**Potenciální Dopad:**
- Urychlení rozhodovacích procesů při nákupu/prodeji
- Demokratizace přístupu k pokročilým tržním analýzám
- Zlepšení transparentnosti realitního trhu

## Komplexní Implementace v Pythonu

````python
langchain==0.1.0
langchain-openai==0.0.5
langchain-community==0.0.12
chromadb==0.4.22
psycopg2-binary==2.9.9
geopandas==0.14.2
folium==0.15.1
requests==2.31.0
pandas==2.1.4
numpy==1.24.3
streamlit==1.29.0
plotly==5.17.0
scikit-learn==1.3.2
openai==1.6.1
python-dotenv==1.0.0
fastapi==0.104.1
uvicorn==0.24.0
````

````python
import os
from dotenv import load_dotenv

load_dotenv()

class Settings:
    OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
    POSTGRES_URL = os.getenv("POSTGRES_URL", "postgresql://user:password@localhost:5432/realestate")
    CHROMA_PERSIST_DIR = "./chroma_db"
    ZILLOW_API_KEY = os.getenv("ZILLOW_API_KEY")
    
    # Geoprostorové nastavení
    DEFAULT_RADIUS_KM = 5.0
    MAX_PROPERTIES_RETURN = 100
    
    # Embedding model
    EMBEDDING_MODEL = "text-embedding-3-small"
    CHAT_MODEL = "gpt-4-turbo-preview"

settings = Settings()
````

````python
from sqlalchemy import create_engine, Column, Integer, String, Float, DateTime, Text, Boolean
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from geoalchemy2 import Geometry
import datetime

Base = declarative_base()

class Property(Base):
    __tablename__ = 'properties'
    
    id = Column(Integer, primary_key=True)
    address = Column(String(255), nullable=False)
    city = Column(String(100), nullable=False)
    state = Column(String(50), nullable=False)
    zip_code = Column(String(20))
    price = Column(Float)
    bedrooms = Column(Integer)
    bathrooms = Column(Float)
    square_feet = Column(Integer)
    property_type = Column(String(50))
    year_built = Column(Integer)
    listing_date = Column(DateTime, default=datetime.datetime.utcnow)
    description = Column(Text)
    geom = Column(Geometry('POINT'))
    is_active = Column(Boolean, default=True)

class Neighborhood(Base):
    __tablename__ = 'neighborhoods'
    
    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)
    city = Column(String(100), nullable=False)
    median_income = Column(Float)
    population = Column(Integer)
    crime_rate = Column(Float)
    school_rating = Column(Float)
    walkability_score = Column(Integer)
    geom = Column(Geometry('POLYGON'))

class MarketReport(Base):
    __tablename__ = 'market_reports'
    
    id = Column(Integer, primary_key=True)
    area = Column(String(100), nullable=False)
    report_date = Column(DateTime, default=datetime.datetime.utcnow)
    median_price = Column(Float)
    price_change_1m = Column(Float)
    price_change_6m = Column(Float)
    price_change_1y = Column(Float)
    inventory_count = Column(Integer)
    days_on_market = Column(Float)
    content = Column(Text)
````

````python
import pandas as pd
import numpy as np
import random
from datetime import datetime, timedelta
import json

class SampleDataGenerator:
    def __init__(self):
        self.cities = [
            {"name": "Praha", "lat": 50.0755, "lon": 14.4378},
            {"name": "Brno", "lat": 49.1951, "lon": 16.6068},
            {"name": "Ostrava", "lat": 49.8209, "lon": 18.2625},
            {"name": "Plzeň", "lat": 49.7384, "lon": 13.3736},
            {"name": "Liberec", "lat": 50.7663, "lon": 15.0543}
        ]
        
        self.property_types = ["Byt", "Rodinný dům", "Kancelář", "Obchodní prostor", "Garáž"]
        self.neighborhoods = ["Centrum", "Sídliště", "Předměstí", "Nové město", "Historické centrum"]
    
    def generate_properties(self, count=1000):
        properties = []
        
        for i in range(count):
            city = random.choice(self.cities)
            # Náhodná pozice v okolí města (±0.1 stupně)
            lat = city["lat"] + random.uniform(-0.1, 0.1)
            lon = city["lon"] + random.uniform(-0.1, 0.1)
            
            property_type = random.choice(self.property_types)
            bedrooms = random.randint(1, 5) if property_type in ["Byt", "Rodinný dům"] else 0
            bathrooms = random.randint(1, 3) if property_type in ["Byt", "Rodinný dům"] else 1
            
            # Cena podle typu a lokace
            base_price = {
                "Byt": random.randint(2000000, 8000000),
                "Rodinný dům": random.randint(4000000, 15000000),
                "Kancelář": random.randint(3000000, 12000000),
                "Obchodní prostor": random.randint(2500000, 10000000),
                "Garáž": random.randint(300000, 800000)
            }[property_type]
            
            # Praha je dražší
            if city["name"] == "Praha":
                base_price *= 1.5
            
            properties.append({
                "id": i + 1,
                "address": f"{random.choice(['Hlavní', 'Školní', 'Nádražní', 'Kostelní', 'Zahradní'])} {random.randint(1, 200)}",
                "city": city["name"],
                "state": "Česká republika",
                "zip_code": f"{random.randint(100, 999)}{random.randint(10, 99)}",
                "price": base_price,
                "bedrooms": bedrooms,
                "bathrooms": bathrooms,
                "square_feet": random.randint(30, 300),
                "property_type": property_type,
                "year_built": random.randint(1960, 2023),
                "listing_date": datetime.now() - timedelta(days=random.randint(1, 90)),
                "description": f"Krásný {property_type.lower()} v {city['name']}. Výborná lokalita s dobrou dostupností.",
                "latitude": lat,
                "longitude": lon,
                "is_active": True
            })
        
        return pd.DataFrame(properties)
    
    def generate_neighborhoods(self):
        neighborhoods = []
        
        for city in self.cities:
            for i, neighborhood in enumerate(self.neighborhoods):
                neighborhoods.append({
                    "id": len(neighborhoods) + 1,
                    "name": neighborhood,
                    "city": city["name"],
                    "median_income": random.randint(25000, 80000),
                    "population": random.randint(5000, 50000),
                    "crime_rate": random.uniform(0.5, 5.0),
                    "school_rating": random.uniform(6.0, 10.0),
                    "walkability_score": random.randint(50, 100),
                    "latitude": city["lat"] + random.uniform(-0.05, 0.05),
                    "longitude": city["lon"] + random.uniform(-0.05, 0.05)
                })
        
        return pd.DataFrame(neighborhoods)
    
    def generate_market_reports(self):
        reports = []
        
        for city in self.cities:
            for i in range(6):  # 6 měsíců dat
                date = datetime.now() - timedelta(days=30 * i)
                median_price = random.randint(3000000, 8000000)
                
                if city["name"] == "Praha":
                    median_price *= 1.5
                
                content = f"""
                Tržní zpráva pro {city['name']} - {date.strftime('%B %Y')}
                
                Mediánová cena nemovitostí dosáhla {median_price:,.0f} Kč, což představuje 
                {"růst" if random.random() > 0.5 else "pokles"} oproti předchozímu měsíci.
                
                Klíčové trendy:
                - Zvýšená poptávka po energeticky úsporných nemovitostech
                - Rostoucí zájem o předměstské lokality
                - Stabilní úrokové sazby podporují investice
                
                Prognóza: Očekáváme {random.choice(["mírný růst", "stabilitu", "korekci"])} 
                cen v příštích 3 měsících.
                """
                
                reports.append({
                    "id": len(reports) + 1,
                    "area": city["name"],
                    "report_date": date,
                    "median_price": median_price,
                    "price_change_1m": random.uniform(-5.0, 8.0),
                    "price_change_6m": random.uniform(-10.0, 15.0),
                    "price_change_1y": random.uniform(-15.0, 25.0),
                    "inventory_count": random.randint(500, 3000),
                    "days_on_market": random.uniform(30, 120),
                    "content": content.strip()
                })
        
        return pd.DataFrame(reports)
    
    def save_all_data(self):
        """Generuje a uloží všechna ukázková data"""
        properties_df = self.generate_properties(1000)
        neighborhoods_df = self.generate_neighborhoods()
        reports_df = self.generate_market_reports()
        
        properties_df.to_csv("data/properties.csv", index=False)
        neighborhoods_df.to_csv("data/neighborhoods.csv", index=False)
        reports_df.to_csv("data/market_reports.csv", index=False)
        
        print("Ukázková data byla úspěšně vygenerována a uložena!")
        return properties_df, neighborhoods_df, reports_df

if __name__ == "__main__":
    generator = SampleDataGenerator()
    generator.save_all_data()
````

````python
import chromadb
from chromadb.config import Settings as ChromaSettings
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.schema import Document
import pandas as pd
from typing import List, Dict, Any
import logging

logger = logging.getLogger(__name__)

class PropertyVectorStore:
    def __init__(self, persist_directory: str, collection_name: str = "properties"):
        self.persist_directory = persist_directory
        self.collection_name = collection_name
        self.embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
        self.vectorstore = None
        self._initialize_vectorstore()
    
    def _initialize_vectorstore(self):
        """Inicializuje Chroma vector store"""
        try:
            client_settings = ChromaSettings(
                persist_directory=self.persist_directory,
                is_persistent=True
            )
            
            self.vectorstore = Chroma(
                collection_name=self.collection_name,
                embedding_function=self.embeddings,
                persist_directory=self.persist_directory,
                client_settings=client_settings
            )
            logger.info("Vector store úspěšně inicializován")
        except Exception as e:
            logger.error(f"Chyba při inicializaci vector store: {e}")
            raise
    
    def add_properties(self, properties_df: pd.DataFrame):
        """Přidá nemovitosti do vector store"""
        documents = []
        
        for _, property_data in properties_df.iterrows():
            # Vytvoření textové reprezentace nemovitosti
            content = self._create_property_text(property_data)
            
            metadata = {
                "property_id": str(property_data["id"]),
                "city": property_data["city"],
                "property_type": property_data["property_type"],
                "price": float(property_data["price"]),
                "bedrooms": int(property_data.get("bedrooms", 0)),
                "bathrooms": float(property_data.get("bathrooms", 0)),
                "square_feet": int(property_data.get("square_feet", 0)),
                "latitude": float(property_data.get("latitude", 0)),
                "longitude": float(property_data.get("longitude", 0))
            }
            
            doc = Document(page_content=content, metadata=metadata)
            documents.append(doc)
        
        # Přidání dokumentů do vector store
        self.vectorstore.add_documents(documents)
        logger.info(f"Přidáno {len(documents)} nemovitostí do vector store")
    
    def add_market_reports(self, reports_df: pd.DataFrame):
        """Přidá tržní zprávy do vector store"""
        documents = []
        
        for _, report in reports_df.iterrows():
            content = f"""
            Tržní zpráva: {report['area']}
            Datum: {report['report_date']}
            Mediánová cena: {report['median_price']:,.0f} Kč
            
            {report['content']}
            """
            
            metadata = {
                "type": "market_report",
                "area": report["area"],
                "report_date": str(report["report_date"]),
                "median_price": float(report["median_price"])
            }
            
            doc = Document(page_content=content.strip(), metadata=metadata)
            documents.append(doc)
        
        self.vectorstore.add_documents(documents)
        logger.info(f"Přidáno {len(documents)} tržních zpráv do vector store")
    
    def _create_property_text(self, property_data: Dict[str, Any]) -> str:
        """Vytvoří textovou reprezentaci nemovitosti pro embedding"""
        text = f"""
        Adresa: {property_data['address']}, {property_data['city']}
        Typ nemovitosti: {property_data['property_type']}
        Cena: {property_data['price']:,.0f} Kč
        Pokoje: {property_data.get('bedrooms', 'N/A')}
        Koupelny: {property_data.get('bathrooms', 'N/A')}
        Plocha: {property_data.get('square_feet', 'N/A')} m²
        Rok stavby: {property_data.get('year_built', 'N/A')}
        
        Popis: {property_data.get('description', 'Bez popisu')}
        """
        return text.strip()
    
    def similarity_search(self, query: str, k: int = 5, filters: Dict[str, Any] = None) -> List[Document]:
        """Vyhledá podobné nemovitosti podle dotazu"""
        if filters:
            return self.vectorstore.similarity_search(query, k=k, filter=filters)
        return self.vectorstore.similarity_search(query, k=k)
    
    def similarity_search_with_location(self, query: str, lat: float, lon: float, 
                                      radius_km: float = 5.0, k: int = 5) -> List[Document]:
        """Vyhledá nemovitosti s geografickým filtrem"""
        # Chroma nativně nepodporuje geografické dotazy, 
        # implementujeme jednoduchý filtr vzdálenosti
        all_results = self.vectorstore.similarity_search(query, k=k*3)
        
        filtered_results = []
        for doc in all_results:
            if len(filtered_results) >= k:
                break
                
            doc_lat = doc.metadata.get("latitude", 0)
            doc_lon = doc.metadata.get("longitude", 0)
            
            distance = self._calculate_distance(lat, lon, doc_lat, doc_lon)
            if distance <= radius_km:
                doc.metadata["distance_km"] = distance
                filtered_results.append(doc)
        
        return filtered_results
    
    def _calculate_distance(self, lat1: float, lon1: float, lat2: float, lon2: float) -> float:
        """Výpočet vzdálenosti mezi dvěma body (Haversine formula)"""
        import math
        
        R = 6371  # poloměr Země v km
        
        lat1_rad = math.radians(lat1)
        lat2_rad = math.radians(lat2)
        delta_lat = math.radians(lat2 - lat1)
        delta_lon = math.radians(lon2 - lon1)
        
        a = (math.sin(delta_lat/2) * math.sin(delta_lat/2) +
             math.cos(lat1_rad) * math.cos(lat2_rad) *
             math.sin(delta_lon/2) * math.sin(delta_lon/2))
        
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
        distance = R * c
        
        return distance
````

````python
from langchain_openai import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.prompts import PromptTemplate
from langchain.schema import Document
from typing import List, Dict, Any, Optional
import logging

logger = logging.getLogger(__name__)

class RealEstateRAGEngine:
    def __init__(self, vector_store, model_name: str = "gpt-4-turbo-preview"):
        self.vector_store = vector_store
        self.llm = ChatOpenAI(model=model_name, temperature=0.1)
        self.qa_chain = self._create_qa_chain()
    
    def _create_qa_chain(self):
        """Vytvoří QA řetězec s custom promptem"""
        template = """
        Jste expertní realitní poradce s přístupem k aktuální databázi nemovitostí a tržních zpráv.
        Odpovídejte v češtině a poskytněte konkrétní, praktické a užitečné informace.
        
        Kontext: {context}
        
        Otázka: {question}
        
        Instrukce:
        1. Analyzujte poskytnutý kontext a identifikujte relevantní nemovitosti nebo informace
        2. Poskytněte konkrétní doporučení s uvedením cen, lokalit a vlastností
        3. Pokud je to relevantní, zahrňte tržní trendy a prognózy
        4. Buďte konkrétní ohledně výhod a nevýhod jednotlivých možností
        5. Pokud nemáte dostatek informací, jasně to uveďte
        
        Odpověď:
        """
        
        prompt = PromptTemplate(
            template=template,
            input_variables=["context", "question"]
        )
        
        return RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type="stuff",
            retriever=self.vector_store.vectorstore.as_retriever(search_kwargs={"k": 5}),
            chain_type_kwargs={"prompt": prompt},
            return_source_documents=True
        )
    
    def query(self, question: str, filters: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Zpracuje dotaz pomocí RAG"""
        try:
            # Pokud jsou poskytnuty filtry, použije je pro vyhledávání
            if filters:
                relevant_docs = self.vector_store.similarity_search(
                    question, k=5, filters=filters
                )
                context = "\n\n".join([doc.page_content for doc in relevant_docs])
                
                # Ruční vytvoření odpovědi s kontextem
                response = self._generate_response_with_context(question, context, relevant_docs)
            else:
                # Použití standardního QA řetězce
                result = self.qa_chain({"query": question})
                response = {
                    "answer": result["result"],
                    "source_documents": result["source_documents"]
                }
            
            return response
            
        except Exception as e:
            logger.error(f"Chyba při zpracování dotazu: {e}")
            return {
                "answer": "Omlouváme se, při zpracování vašeho dotazu došlo k chybě.",
                "source_documents": []
            }
    
    def query_with_location(self, question: str, lat: float, lon: float, 
                          radius_km: float = 5.0) -> Dict[str, Any]:
        """Zpracuje geograficky omezený dotaz"""
        try:
            relevant_docs = self.vector_store.similarity_search_with_location(
                question, lat, lon, radius_km, k=5
            )
            
            context = "\n\n".join([doc.page_content for doc in relevant_docs])
            response = self._generate_response_with_context(question, context, relevant_docs)
            
            # Přidání informace o geografickém omezení
            if relevant_docs:
                distances = [doc.metadata.get("distance_km", 0) for doc in relevant_docs]
                response["geographic_info"] = {
                    "search_center": {"lat": lat, "lon": lon},
                    "radius_km": radius_km,
                    "found_properties": len(relevant_docs),
                    "closest_distance_km": min(distances) if distances else None
                }
            
            return response
            
        except Exception as e:
            logger.error(f"Chyba při geografickém dotazu: {e}")
            return {
                "answer": "Omlouváme se, při zpracování vašeho geografického dotazu došlo k chybě.",
                "source_documents": []
            }
    
    def _generate_response_with_context(self, question: str, context: str, 
                                      source_docs: List[Document]) -> Dict[str, Any]:
        """Generuje odpověď s daným kontextem"""
        prompt = f"""
        Jste expertní realitní poradce. Na základě následujícího kontextu odpovězte na otázku v češtině.
        
        Kontext:
        {context}
        
        Otázka: {question}
        
        Poskytněte konkrétní, praktické doporučení s uvedením cen, lokalit a vlastností nemovitostí.
        """
        
        response = self.llm.invoke(prompt)
        
        return {
            "answer": response.content,
            "source_documents": source_docs
        }
    
    def get_market_summary(self, city: str) -> Dict[str, Any]:
        """Získá shrnutí trhu pro konkrétní město"""
        question = f"Jaká je aktuální situace na realitním trhu v {city}? Poskytněte shrnutí cen, trendů a prognóz."
        
        filters = {"area": city}
        return self.query(question, filters)
    
    def find_similar_properties(self, property_description: str, max_price: Optional[float] = None) -> Dict[str, Any]:
        """Najde podobné nemovitosti podle popisu"""
        question = f"Najděte nemovitosti podobné tomuto popisu: {property_description}"
        
        if max_price:
            question += f" s maximální cenou {max_price:,.0f} Kč"
        
        return self.query(question)
    
    def get_investment_advice(self, budget: float, investment_type: str = "dlouhodobá") -> Dict[str, Any]:
        """Poskytne investiční doporučení"""
        question = f"""
        Hledám investiční příležitosti s rozpočtem {budget:,.0f} Kč pro {investment_type} investici.
        Jaké nemovitosti byste doporučili a proč? Zahrňte analýzu výnosnosti a rizik.
        """
        
        return self.query(question)
````

````python
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List, Dict, Any
import uvicorn
import logging
from pathlib import Path
import sys

# Přidání root složky do cesty
sys.path.append(str(Path(__file__).parent.parent))

from core.vector_store import PropertyVectorStore
from core.rag_engine import RealEstateRAGEngine
from data.sample_data_generator import SampleDataGenerator
from config.settings import settings
import pandas as pd

# Konfigurace logování
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="Real Estate Intelligence API", version="1.0.0")

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Globální proměnné
vector_store = None
rag_engine = None

class PropertyQuery(BaseModel):
    question: str
    city: Optional[str] = None
    max_price: Optional[float] = None
    property_type: Optional[str] = None

class LocationQuery(BaseModel):
    question: str
    latitude: float
    longitude: float
    radius_km: float = 5.0

class InvestmentQuery(BaseModel):
    budget: float
    investment_type: str = "dlouhodobá"
    preferred_cities: Optional[List[str]] = None

@app.on_event("startup")
async def startup_event():
    """Inicializace aplikace při startu"""
    global vector_store, rag_engine
    
    try:
        logger.info("Inicializace Real Estate Intelligence API...")
        
        # Inicializace vector store
        vector_store = PropertyVectorStore(
            persist_directory=settings.CHROMA_PERSIST_DIR,
            collection_name="real_estate"
        )
        
        # Kontrola existence dat
        if not Path("data/properties.csv").exists():
            logger.info("Generování ukázkových dat...")
            generator = SampleDataGenerator()
            generator.save_all_data()
        
        # Načtení dat do vector store
        try:
            # Test, zda už jsou data v vector store
            test_search = vector_store.similarity_search("test", k=1)
            if not test_search:
                raise Exception("Prázdný vector store")
        except:
            logger.info("Načítání dat do vector store...")
            properties_df = pd.read_csv("data/properties.csv")
            reports_df = pd.read_csv("data/market_reports.csv")
            
            vector_store.add_properties(properties_df)
            vector_store.add_market_reports(reports_df)
        
        # Inicializace RAG engine
        rag_engine = RealEstateRAGEngine(vector_store)
        
        logger.info("API úspěšně inicializováno!")
        
    except Exception as e:
        logger.error(f"Chyba při inicializaci API: {e}")
        raise

@app.get("/")
async def root():
    """Základní endpoint"""
    return {
        "message": "Real Estate Intelligence API",
        "version": "1.0.0",
        "status": "running"
    }

@app.post("/query/")
async def query_properties(query: PropertyQuery):
    """Obecný dotaz na nemovitosti"""
    try:
        # Vytvoření filtrů
        filters = {}
        if query.city:
            filters["city"] = query.city
        if query.max_price:
            filters["price"] = {"$lte": query.max_price}
        if query.property_type:
            filters["property_type"] = query.property_type
        
        result = rag_engine.query(query.question, filters if filters else None)
        
        return {
            "success": True,
            "answer": result["answer"],
            "sources_count": len(result["source_documents"]),
            "query_params": {
                "city": query.city,
                "max_price": query.max_price,
                "property_type": query.property_type
            }
        }
        
    except Exception as e:
        logger.error(f"Chyba při zpracování dotazu: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/query/location/")
async def query_by_location(query: LocationQuery):
    """Geograficky omezený dotaz"""
    try:
        result = rag_engine.query_with_location(
            question=query.question,
            lat=query.latitude,
            lon=query.longitude,
            radius_km=query.radius_km
        )
        
        return {
            "success": True,
            "answer": result["answer"],
            "sources_count": len(result["source_documents"]),
            "geographic_info": result.get("geographic_info", {}),
            "query_params": {
                "latitude": query.latitude,
                "longitude": query.longitude,
                "radius_km": query.radius_km
            }
        }
        
    except Exception as e:
        logger.error(f"Chyba při geografickém dotazu: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/market/{city}")
async def get_market_summary(city: str):
    """Získání tržního shrnutí pro město"""
    try:
        result = rag_engine.get_market_summary(city)
        
        return {
            "success": True,
            "city": city,
            "market_summary": result["answer"],
            "sources_count": len(result["source_documents"])
        }
        
    except Exception as e:
        logger.error(f"Chyba při získávání tržního shrnutí: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/investment/advice/")
async def get_investment_advice(query: InvestmentQuery):
    """Získání investičního poradenství"""
    try:
        result = rag_engine.get_investment_advice(
            budget=query.budget,
            investment_type=query.investment_type
        )
        
        return {
            "success": True,
            "budget": query.budget,
            "investment_type": query.investment_type,
            "advice": result["answer"],
            "sources_count": len(result["source_documents"])
        }
        
    except Exception as e:
        logger.error(f"Chyba při poskytování investičního poradenství: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/properties/search/")
async def search_properties(
    q: str = Query(..., description="Vyhledávací dotaz"),
    city: Optional[str] = Query(None, description="Město"),
    min_price: Optional[float] = Query(None, description="Minimální cena"),
    max_price: Optional[float] = Query(None, description="Maximální cena"),
    property_type: Optional[str] = Query(None, description="Typ nemovitosti"),
    limit: int = Query(5, description="Počet výsledků")
):
    """Vyhledávání nemovitostí s filtry"""
    try:
        # Vytvoření filtrů
        filters = {}
        if city:
            filters["city"] = city
        if property_type:
            filters["property_type"] = property_type
        
        # Vyhledání podobných nemovitostí
        documents = vector_store.similarity_search(q, k=limit, filters=filters if filters else None)
        
        # Filtrování podle ceny
        filtered_docs = []
        for doc in documents:
            price = doc.metadata.get("price", 0)
            if min_price and price < min_price:
                continue
            if max_price and price > max_price:
                continue
            filtered_docs.append(doc)
        
        # Formátování výsledků
        results = []
        for doc in filtered_docs:
            results.append({
                "property_id": doc.metadata.get("property_id"),
                "city": doc.metadata.get("city"),
                "property_type": doc.metadata.get("property_type"),
                "price": doc.metadata.get("price"),
                "bedrooms": doc.metadata.get("bedrooms"),
                "bathrooms": doc.metadata.get("bathrooms"),
                "square_feet": doc.metadata.get("square_feet"),
                "description": doc.page_content[:200] + "..." if len(doc.page_content) > 200 else doc.page_content
            })
        
        return {
            "success": True,
            "query": q,
            "filters": {
                "city": city,
                "min_price": min_price,
                "max_price": max_price,
                "property_type": property_type
            },
            "results_count": len(results),
            "results": results
        }
        
    except Exception as e:
        logger.error(f"Chyba při vyhledávání nemovitostí: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/health/")
async def health_check():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "vector_store": "initialized" if vector_store else "not_initialized",
        "rag_engine": "initialized" if rag_engine else "not_initialized"
    }

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
````

````python
import streamlit as st
import requests
import pandas as pd
import folium
from streamlit_folium import folium_static
import plotly.express as px
import plotly.graph_objects as go
from typing import Dict, Any
import logging

# Konfigurace stránky
st.set_page_config(
    page_title="Real Estate Intelligence",
    page_icon="🏠",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Konfigurace API
API_BASE_URL = "http://localhost:8000"

class RealEstateApp:
    def __init__(self):
        self.setup_sidebar()
    
    def setup_sidebar(self):
        """Nastavení postranního panelu"""
        st.sidebar.title("🏠 Real Estate Intelligence")
        st.sidebar.markdown("---")
        
        self.page = st.sidebar.selectbox(
            "Vyberte stránku:",
            ["🔍 Vyhledávání nemovitostí", "📊 Tržní analýza", "💰 Investiční poradenství", "🗺️ Geografické vyhledávání"]
        )
    
    def run(self):
        """Hlavní metoda aplikace"""
        if self.page == "🔍 Vyhledávání nemovitostí":
            self.property_search_page()
        elif self.page == "📊 Tržní analýza":
            self.market_analysis_page()
        elif self.page == "💰 Investiční poradenství":
            self.investment_advice_page()
        elif self.page == "🗺️ Geografické vyhledávání":
            self.geographic_search_page()
    
    def property_search_page(self):
        """Stránka pro vyhledávání nemovitostí"""
        st.title("🔍 Vyhledávání nemovitostí")
        st.markdown("Zadejte svůj dotaz a najděte ideální nemovitost pomocí AI asistenta.")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            question = st.text_area(
                "Váš dotaz:",
                placeholder="Např: Hledám dvoupokojový byt v Praze do 5 milionů korun s balkonem",
                height=100
            )
        
        with col2:
            st.subheader("Filtry")
            city = st.selectbox("Město:", ["", "Praha", "Brno", "Ostrava", "Plzeň", "Liberec"])
            max_price = st.number_input("Max. cena (Kč):", min_value=0, value=0, step=100000)
            property_type = st.selectbox("Typ nemovitosti:", ["", "Byt", "Rodinný dům", "Kancelář", "Obchodní prostor", "Garáž"])
        
        if st.button("🔍 Vyhledat", type="primary"):
            if question:
                with st.spinner("Hledám nemovitosti..."):
                    response = self.search_properties(question, city, max_price, property_type)
                    self.display_search_results(response)
            else:
                st.error("Zadejte prosím váš dotaz.")
    
    def market_analysis_page(self):
        """Stránka pro tržní analýzu"""
        st.title("📊 Tržní analýza")
        st.markdown("Získejte aktuální přehled o realitním trhu ve vybraných městech.")
        
        col1, col2 = st.columns([1, 2])
        
        with col1:
            selected_city = st.selectbox("Vyberte město:", ["Praha", "Brno", "Ostrava", "Plzeň", "Liberec"])
            
            if st.button("📈 Získat tržní analýzu", type="primary"):
                with st.spinner("Získávám tržní data..."):
                    response = self.get_market_summary(selected_city)
                    
                    if response and response.get("success"):
                        st.success(f"Tržní analýza pro {selected_city}")
                        st.markdown(response["market_summary"])
                    else:
                        st.error("Nepodařilo se získat tržní analýzu.")
        
        with col2:
            st.subheader("📊 Ukázkové grafy")
            # Ukázkový graf cenových trendů
            self.display_sample_charts()
    
    def investment_advice_page(self):
        """Stránka pro investiční poradenství"""
        st.title("💰 Investiční poradenství")
        st.markdown("Získejte personalizované investiční doporučení na základě vašeho rozpočtu a cílů.")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            budget = st.number_input("Rozpočet (Kč):", min_value=100000, value=3000000, step=100000)
            investment_type = st.selectbox("Typ investice:", ["dlouhodobá", "krátkodobá", "pronájem", "renovace"])
            
            preferred_cities = st.multiselect(
                "Preferovaná města:",
                ["Praha", "Brno", "Ostrava", "Plzeň", "Liberec"]
            )
        
        with col2:
            st.subheader("ℹ️ Informace o investicích")
            st.info("""
            **Dlouhodobá investice**: Nákup pro držbu 5+ let
            **Krátkodobá investice**: Rychlý prodej do 2 let
            **Pronájem**: Nemovitost pro výnosový pronájem
            **Renovace**: Nákup k rekonstrukci a prodeji
            """)
        
        if st.button("💡 Získat doporučení", type="primary"):
            with st.spinner("Analyzujem investiční příležitosti..."):
                response = self.get_investment_advice(budget, investment_type)
                
                if response and response.get("success"):
                    st.success("Investiční doporučení")
                    st.markdown(response["advice"])
                else:
                    st.error("Nepodařilo se získat investiční doporučení.")
    
    def geographic_search_page(self):
        """Stránka pro geografické vyhledávání"""
        st.title("🗺️ Geografické vyhledávání")
        st.markdown("Vyhledejte nemovitosti v konkrétní oblasti na mapě.")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("Parametry vyhledávání")
            latitude = st.number_input("Zeměpisná šířka:", value=50.0755, format="%.6f")
            longitude = st.number_input("Zeměpisná délka:", value=14.4378, format="%.6f")
            radius = st.slider("Poloměr vyhledávání (km):", min_value=1, max_value=20, value=5)
            
            question = st.text_area(
                "Dotaz:",
                placeholder="Např: Najděte byty vhodné pro mladou rodinu",
                height=80
            )
            
            if st.button("🗺️ Vyhledat v oblasti", type="primary"):
                if question:
                    with st.spinner("Vyhledávám v zadané oblasti..."):
                        response = self.search_by_location(question, latitude, longitude, radius)
                        self.display_location_search_results(response, latitude, longitude, radius)
                else:
                    st.error("Zadejte prosím váš dotaz.")
        
        with col2:
            st.subheader("🗺️ Mapa vyhledávání")
            # Vytvoření základní mapy
            m = folium.Map(location=[latitude, longitude], zoom_start=12)
            
            # Přidání kruhu označujícího oblast vyhledávání
            folium.Circle(
                location=[latitude, longitude],
                radius=radius * 1000,  # převod na metry
                popup=f"Oblast vyhledávání ({radius} km)",
                color="blue",
                fill=True,
                opacity=0.3
            ).add_to(m)
            
            # Přidání markeru pro střed
            folium.Marker(
                location=[latitude, longitude],
                popup="Střed vyhledávání",
                icon=folium.Icon(color="red", icon="info-sign")
            ).add_to(m)
            
            folium_static(m, width=400, height=300)
    
    def search_properties(self, question: str, city: str = None, max_price: float = None, property_type: str = None) -> Dict[str, Any]:
        """Vyhledávání nemovitostí přes API"""
        try:
            payload = {"question": question}
            if city:
                payload["city"] = city
            if max_price and max_price > 0:
                payload["max_price"] = max_price
            if property_type:
                payload["property_type"] = property_type
            
            response = requests.post(f"{API_BASE_URL}/query/", json=payload)
            return response.json() if response.status_code == 200 else None
        except Exception as e:
            st.error(f"Chyba při komunikaci s API: {e}")
            return None
    
    def get_market_summary(self, city: str) -> Dict[str, Any]:
        """Získání tržního shrnutí přes API"""
        try:
            response = requests.get(f"{API_BASE_URL}/market/{city}")
            return response.json() if response.status_code == 200 else None
        except Exception as e:
            st.error(f"Chyba při získávání tržních dat: {e}")
            return None
    
    def get_investment_advice(self, budget: float, investment_type: str) -> Dict[str, Any]:
        """Získání investičního poradenství přes API"""
        try:
            payload = {
                "budget": budget,
                "investment_type": investment_type
            }
            response = requests.post(f"{API_BASE_URL}/investment/advice/", json=payload)
            return response.json() if response.status_code == 200 else None
        except Exception as e:
            st.error(f"Chyba při získávání investičního poradenství: {e}")
            return None
    
    def search_by_location(self, question: str, lat: float, lon: float, radius: float) -> Dict[str, Any]:
        """Geografické vyhledávání přes API"""
        try:
            payload = {
                "question": question,
                "latitude": lat,
                "longitude": lon,
                "radius_km": radius
            }
            response = requests.post(f"{API_BASE_URL}/query/location/", json=payload)
            return response.json() if response.status_code == 200 else None
        except Exception as e:
            st.error(f"Chyba při geografickém vyhledávání: {e}")
            return None
    
    def display_search_results(self, response: Dict[str, Any]):
        """Zobrazení výsledků vyhledávání"""
        if response and response.get("success"):
            st.success("✅ Výsledky vyhledávání")
            st.markdown(response["answer"])
            
            if response.get("sources_count", 0) > 0:
                st.info(f"📄 Nalezeno {response['sources_count']} relevantních nemovitostí")
        else:
            st.error("❌ Nepodařilo se najít žádné nemovitosti odpovídající vašim kritériím.")
    
    def display_location_search_results(self, response: Dict[str, Any], lat: float, lon: float, radius: float):
        """Zobrazení výsledků geografického vyhledávání"""
        if response and response.get("success"):
            st.success("✅ Výsledky geografického vyhledávání")
            st.markdown(response["answer"])
            
            geographic_info = response.get("geographic_info", {})
            if geographic_info:
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("Nalezené nemovitosti", geographic_info.get("found_properties", 0))
                with col2:
                    st.metric("Poloměr (km)", geographic_info.get("radius_km", 0))
                with col3:
                    closest_distance = geographic_info.get("closest_distance_km")
                    if closest_distance:
                        st.metric("Nejbližší (km)", f"{closest_distance:.1f}")
        else:
            st.error("❌ Nepodařilo se najít žádné nemovitosti v zadané oblasti.")
    
    def display_sample_charts(self):
        """Zobrazení ukázkových grafů"""
        # Ukázková data pro grafy
        months = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen"]
        prices = [4500000, 4600000, 4750000, 4800000, 4900000, 5000000]
        
        # Graf cenových trendů
        fig = px.line(
            x=months, 
            y=prices,
            title="Vývoj mediánových cen nemovitostí",
            labels={"x": "Měsíc", "y": "Cena (Kč)"}
        )
        fig.update_traces(line_color="blue", line_width=3)
        st.plotly_chart(fig, use_container_width=True)
        
        # Graf distribuce typů nemovitostí
        property_types = ["Byt", "Rodinný dům", "Kancelář", "Obchodní prostor"]
        counts = [450, 230, 120, 80]
        
        fig2 = px.pie(
            values=counts,
            names=property_types,
            title="Distribuce typů nemovitostí na trhu"
        )
        st.plotly_chart(fig2, use_container_width=True)

def main():
    """Hlavní funkce aplikace"""
    try:
        # Kontrola dostupnosti API
        response = requests.get(f"{API_BASE_URL}/health/")
        if response.status_code != 200:
            st.error("⚠️ API server není dostupný. Spusťte prosím API server na portu 8000.")
            st.code("python api/main.py")
            return
    except requests.exceptions.ConnectionError:
        st.error("⚠️ Nepodařilo se připojit k API serveru. Ujistěte se, že běží na http://localhost:8000")
        st.code("python api/main.py")
        return
    
    # Spuštění aplikace
    app = RealEstateApp()
    app.run()

if __name__ == "__main__":
    main()
````

````python
import subprocess
import sys
import time
import os
from pathlib import Path

def check_requirements():
    """Kontrola a instalace požadovaných balíčků"""
    print("🔍 Kontrolujem požadované balíčky...")
    
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "-r", "requirements.txt"])
        print("✅ Všechny balíčky jsou nainstalovány")
    except subprocess.CalledProcessError:
        print("❌ Chyba při instalaci balíčků")
        return False
    
    return True

def setup_environment():
    """Nastavení prostředí"""
    print("🔧 Nastavujem prostředí...")
    
    # Vytvoření složek
    os.makedirs("data", exist_ok=True)
    os.makedirs("chroma_db", exist_ok=True)
    
    # Kontrola .env souboru
    if not Path(".env").exists():
        print("📝 Vytvářím .env soubor...")
        with open(".env", "w") as f:
            f.write("""# Real Estate Intelligence System Configuration
OPENAI_API_KEY=your_openai_api_key_here
POSTGRES_URL=postgresql://user:password@localhost:5432/realestate
ZILLOW_API_KEY=your_zillow_api_key_here
""")
        print("⚠️  Nastavte prosím váš OpenAI API klíč v souboru .env")
    
    print("✅ Prostředí je nastaveno")

def generate_sample_data():
    """Generování ukázkových dat"""
    if not Path("data/properties.csv").exists():
        print("📊 Generujem ukázková data...")
        try:
            from data.sample_data_generator import SampleDataGenerator
            generator = SampleDataGenerator()
            generator.save_all_data()
            print("✅ Ukázková data byla vygenerována")
        except Exception as e:
            print(f"❌ Chyba při generování dat: {e}")
            return False
    else:
        print("✅ Ukázková data již existují")
    
    return True

def start_api_server():
    """Spuštění API serveru"""
    print("🚀 Spouštím API server...")
    
    try:
        # Spuštění v novém procesu
        process = subprocess.Popen([
            sys.executable, "-m", "uvicorn", "api.main:app",
            "--host", "0.0.0.0", "--port", "8000", "--reload"
        ])
        
        # Počkání na spuštění
        time.sleep(5)
        
        print("✅ API server běží na http://localhost:8000")
        return process
    
    except Exception as e:
        print(f"❌ Chyba při spuštění API serveru: {e}")
        return None

def start_streamlit_app():
    """Spuštění Streamlit aplikace"""
    print("🎨 Spouštím Streamlit aplikaci...")
    
    try:
        subprocess.run([sys.executable, "-m", "streamlit", "run", "streamlit_app.py"])
    except KeyboardInterrupt:
        print("\n👋 Aplikace byla ukončena")
    except Exception as e:
        print(f"❌ Chyba při spuštění Streamlit aplikace: {e}")

def main():
    """Hlavní funkce pro spuštění celého systému"""
    print("🏠 Real Estate Intelligence System")
    print("=" * 50)
    
    # Kontrola požadavků
    if not check_requirements():
        print("❌ Instalace balíčků selhala")
        return
    
    # Nastavení prostředí
    setup_environment()
    
    # Generování dat
    if not generate_sample_data():
        print("❌ Generování dat selhalo")
        return
    
    # Spuštění API serveru
    api_process = start_api_server()
    if not api_process:
        print("❌ Spuštění API serveru selhalo")
        return
    
    try:
        # Spuštění Streamlit aplikace
        start_streamlit_app()
    finally:
        # Ukončení API serveru
        if api_process:
            print("🛑 Ukončujem API server...")
            api_process.terminate()

if __name__ == "__main__":
    main()
````

## Shrnutí Projektu

Systém Inteligence Realitních Nemovitostí představuje pokročilé RAG řešení, které revolutionizuje způsob, jakým lidé hledají a analyzují nemovitosti. Projekt úspěšně kombinuje:

**Klíčové Technologie:**
- **LangChain** pro orchestraci RAG workflow
- **ChromaDB** pro vektorové ukládání a vyhledávání
- **OpenAI GPT-4** pro generování inteligentních odpovědí
- **FastAPI** pro škálovatelné API rozhraní
- **Streamlit** pro intuitivní uživatelské rozhraní
- **PostGIS koncepty** pro geoprostorové operace

**Hodnota Řešení:**
- **Centralizace dat**: Sjednocuje fragmentované realitní informace
- **AI-powered analýzy**: Poskytuje inteligentní doporučení a prognózy
- **Geografické vyhledávání**: Umožňuje prostorové dotazy a analýzy
- **Škálovatelnost**: Připraveno pro miliony nemovitostí a uživatelů

**Praktické Přínosy:**
- Dramatické urychlení rozhodovacích procesů
- Demokratizace přístupu k pokročilým tržním analýzám  
- Zlepšení transparentnosti a efektivity realitního trhu
- Personalizované investiční poradenství založené na datech

Systém představuje kompletní řešení pro moderní realitní trh, které využívá nejnovější AI technologie pro poskytování špičkových služeb v oblasti nemovitostí.